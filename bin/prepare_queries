#!/bin/bash

set -o errexit

cd $(dirname %0)

POSTGRES_PASSWORD=test_password
PG_URL="postgres://postgres:${POSTGRES_PASSWORD}@127.0.0.1:5432/service"

# Relative paths don't work reliably with sqlx
SQLITE_URL="sqlite://$(pwd)/data/server.db"

function postgres_setup() {
  sqlx database setup --database-url ${PG_URL} --source ./migrations/postgres
  cargo sqlx prepare --database-url ${PG_URL} -- --no-default-features \
    --features postgres --tests
}

function postgres_init() {
  podman run -e POSTGRES_PASSWORD --name sqlx-migration-pg -t docker.io/library/postgres:alpine
}

function postgres_teardown() {
  podman kill --name sqlx-migration-pg || true
  podman rm -fv --name sqlx-migration-pg || true
}

function sqlite_setup() {
  mkdir -p data
  rm -f data/server.db* &>/dev/null

  sqlx database setup --database-url ${SQLITE_URL} --source ./migrations/sqlite \
    --sqlite-create-db-wal true
  cargo sqlx prepare --database-url ${SQLITE_URL} -- --no-default-features \
    --features sqlite --tests
}

sqlite_setup

postgres_init
postgres_setup
postgres_teardown
